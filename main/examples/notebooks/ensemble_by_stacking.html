

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Ensemble by stacking &mdash; DFFML fd401e426 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/tabs.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Transfer Learning" href="transferlearning.html" />
    <link rel="prev" title="Saving and loading models" href="saving_and_loading_models.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> DFFML
          

          
          </a>

          
            
            
              <div class="version">
                fd401e426
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../concepts/index.html">Concepts</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Usage</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../quickstart/model.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Examples</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Notebooks</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="moving_between_models.html">Moving Between Models</a></li>
<li class="toctree-l3"><a class="reference internal" href="evaluating_model_performance.html">Evaluating Model Performance</a></li>
<li class="toctree-l3"><a class="reference internal" href="tuning_models.html">Tuning Models</a></li>
<li class="toctree-l3"><a class="reference internal" href="saving_and_loading_models.html">Saving and loading models</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Ensemble by stacking</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Import-Packages">Import Packages</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Build-our-Dataset">Build our Dataset</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Split-our-data">Split our data</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="transferlearning.html">Transfer Learning</a></li>
<li class="toctree-l3"><a class="reference internal" href="multioutput_models.html">Working with Multi-Output models</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../integration.html">Automating Classification</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shouldi.html">Meta Static Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dataflows.html">DataFlow HTTP Deployment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../innersource/index.html">InnerSource</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mnist.html">MNIST Handwriten Digits</a></li>
<li class="toctree-l2"><a class="reference internal" href="../flower17/flower17.html">Flower17 Species Classification</a></li>
<li class="toctree-l2"><a class="reference internal" href="../or_covid_data_by_county.html">COVID Forecasting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webhook/index.html">Continuous Deployment of DataFlows</a></li>
<li class="toctree-l2"><a class="reference internal" href="../icecream_sales.html">Ice Cream Sales</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data_cleanup/index.html">Data Cleanup</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../plugins/index.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli.html">Command Line</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plugins/service/http/index.html">HTTP API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/base.html">Base</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/log.html">Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/noasync.html">Noasync</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/plugins.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/record.html">Record</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/version.html">Version</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/db/index.html">Db</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/cli/index.html">Cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/df/index.html">Df</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/high_level/index.html">High_Level</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/tuner/index.html">Tuner</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/service/index.html">Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/util/index.html">Util</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/configloader/index.html">Configloader</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/accuracy/index.html">Accuracy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/source/index.html">Source</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/operation/index.html">Operation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/model/index.html">Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/secret/index.html">Secret</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/port/index.html">Port</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/feature/index.html">Feature</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../arch/index.html">Architecture</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Subprojects</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../shouldi.html">shouldi</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Community</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/intel/dffml">GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://intel.github.io/dffml/main/">Master Branch Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../publications.html">Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contact.html">Contact Us</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/index.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../news/index.html">News</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">DFFML</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Examples</a> &raquo;</li>
        
          <li><a href="index.html">Notebooks</a> &raquo;</li>
        
      <li>Ensemble by stacking</li>
    
    


      <li class="wy-breadcrumbs-aside">
        
          
            
              <a href="https://github.com/intel/dffml/blob/main/docs/examples/notebooks/ensemble_by_stacking.nblink" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    


  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<a class="reference external image-reference" href="https://intel.github.io/dffml/main/examples/notebooks/ensemble_by_stacking.ipynb"><img alt="Notebook download button" src="../../_images/Download-.ipynb-button.svg" /></a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<section id="Ensemble-by-stacking">
<h1>Ensemble by stacking<a class="headerlink" href="#Ensemble-by-stacking" title="Permalink to this heading">¶</a></h1>
<p>In this demo, we’ll be using the Red Wine Quality dataset. The dataset can be used with both regression and classification models.</p>
<p>The purpose of this notebook is to build different models and use stacking, an ensemble learning technique, using the DFFML API. <a class="reference external" href="http://www.youtube.com/watch?v=PCoSP-jO9Y8"><img alt="Video Explanation Thumbnail" src="http://img.youtube.com/vi/PCoSP-jO9Y8/0.jpg" /></a></p>
<section id="Import-Packages">
<h2>Import Packages<a class="headerlink" href="#Import-Packages" title="Permalink to this heading">¶</a></h2>
<p>Let us import dffml and other packages that we might need.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dffml</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">nest_asyncio</span>
</pre></div>
</div>
</div>
<p>To use asyncio in a notebook, we need to use nest_asycio.apply()</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nest_asyncio</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
</pre></div>
</div>
</div>
</section>
<section id="Build-our-Dataset">
<h2>Build our Dataset<a class="headerlink" href="#Build-our-Dataset" title="Permalink to this heading">¶</a></h2>
<p>util.Dffml has a very convinient function <a class="reference internal" href="../../api/util/net.html#dffml.util.net.cached_download"><span class="std std-ref">cached_download()</span></a> that can be used to download datasets and make sure you don’t download them if you have already.</p>
<p>The cached_download() has the following parameters:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">url</span></code> (str) – The URL to download</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">target_path</span></code> (str, pathlib.Path) – Path on disk to store download</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">expected_hash</span></code> (str) – SHA384 hash of the contents</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">protocol_allowlist</span></code> (list, optional) – List of strings, one of which the URL must start with. We won’t be using this in our case.</p></li>
</ol>
<p>Don’t forget to calculate the <code class="docutils literal notranslate"><span class="pre">expected_hash</span></code>, you can find out how at <a class="reference internal" href="../../api/util/net.html#dffml.util.net.cached_download"><span class="std std-ref">cached_download()</span></a>!</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_path</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cached_download</span><span class="p">(</span>
    <span class="s2">&quot;https://archive.ics.uci.edu/ml/machine-learning-databases/wine-quality/winequality-red.csv&quot;</span><span class="p">,</span>
    <span class="s2">&quot;wine_quality.csv&quot;</span><span class="p">,</span>
    <span class="s2">&quot;789e98688f9ff18d4bae35afb71b006116ec9c529c1b21563fdaf5e785aea8b3937a55a4919c91ca2b0acb671300072c&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>In Dffml, we try to use asynchronicity where we can, to get that extra bit of performance. Let’s use the async version of load() to load the dataset that we just downloaded into a source. We can easily achieve this by declaring a <a class="reference internal" href="../../api/source/csv.html"><span class="doc">CSVSource</span></a> with the <code class="docutils literal notranslate"><span class="pre">data_path</span></code> and the <code class="docutils literal notranslate"><span class="pre">delimiter</span></code> value since the data we downloaded seems to have a non-comma delimiter.</p>
<p>After that, we can just create an array of records by loading each one through the load() function.</p>
<p>Feel free to also try out the no async version of load().</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">load_dataset</span><span class="p">(</span><span class="n">data_path</span><span class="p">):</span>
    <span class="n">data_source</span> <span class="o">=</span> <span class="n">CSVSource</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">data_path</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">record</span> <span class="k">async</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">load</span><span class="p">(</span><span class="n">data_source</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">data</span>


<span class="n">data</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">load_dataset</span><span class="p">(</span><span class="n">data_path</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>Dffml lets you visualize a record in quite a neat fashion. Lets have a look.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

        Key:    0
                           Record Features
+----------------------------------------------------------------------+
|  fixed acidity  |                        7.4                         |
+----------------------------------------------------------------------+
| volatile acidity|                        0.7                         |
+----------------------------------------------------------------------+
|   citric acid   |                         0                          |
+----------------------------------------------------------------------+
|  residual sugar |                        1.9                         |
+----------------------------------------------------------------------+
|    chlorides    |                       0.076                        |
+----------------------------------------------------------------------+
|free sulfur dioxi|                         11                         |
+----------------------------------------------------------------------+
|total sulfur diox|                         34                         |
+----------------------------------------------------------------------+
|     density     |                       0.9978                       |
+----------------------------------------------------------------------+
|        pH       |                        3.51                        |
+----------------------------------------------------------------------+
|    sulphates    |                        0.56                        |
+----------------------------------------------------------------------+
|     alcohol     |                        9.4                         |
+----------------------------------------------------------------------+
|     quality     |                         5                          |
+----------------------------------------------------------------------+
                                           Prediction:    Undetermined

1599
</pre></div></div>
</div>
</section>
<section id="Split-our-data">
<h2>Split our data<a class="headerlink" href="#Split-our-data" title="Permalink to this heading">¶</a></h2>
<p>Lets split our dataset into train, validation and test splits with a ratio of 60:20:20.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_60pct</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">data_20pct</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">*</span> <span class="mi">20</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_60pct</span><span class="p">,</span> <span class="n">data_20pct</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
959 319
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="n">data_60pct</span><span class="p">]</span>
<span class="n">validation_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data_60pct</span> <span class="p">:</span> <span class="n">data_60pct</span> <span class="o">+</span> <span class="n">data_20pct</span><span class="p">]</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data_60pct</span> <span class="o">+</span> <span class="n">data_20pct</span> <span class="p">:]</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_data</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">validation_data</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_data</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1599 959 319 321
</pre></div></div>
</div>
<section id="Let-the-Ensemble-begin!">
<h3>Let the Ensemble begin!<a class="headerlink" href="#Let-the-Ensemble-begin!" title="Permalink to this heading">¶</a></h3>
<p>As mentioned before, we’ll be using the <code class="docutils literal notranslate"><span class="pre">stacking</span></code> technique to ensemble our models.</p>
<p>The following are the steps to ensemble by <code class="docutils literal notranslate"><span class="pre">stacking</span></code>:</p>
<ol class="arabic simple">
<li><p><strong>Train First-Level Base Models</strong> on train data.</p></li>
<li><p><strong>Use the First-Level Base Models to get predictions on Validation data and Test data.</strong> We will simply use the high-level <code class="docutils literal notranslate"><span class="pre">predict()</span></code> function to get the predictions and store these predictions in lists.</p></li>
<li><p><strong>Stack all the Validation predictions together, and stack Test predictions together.</strong> After this, we will have 2 lists consisting of stacked validation predictions and stacked test predictions.</p></li>
<li><p><strong>Build and Train Level-2 Meta-Model.</strong> The stacked valid predictions will serve as features to train our level-2 meta-model.</p></li>
<li><p><strong>Now our ensembled model is ready to predict.</strong> We can go ahead and predict on stacked test predictions to get our final predictions.</p></li>
</ol>
</section>
<section id="1.-Training-First-Level-Base-Models-on-train-data.">
<h3>1. Training First-Level Base Models on train data.<a class="headerlink" href="#1.-Training-First-Level-Base-Models-on-train-data." title="Permalink to this heading">¶</a></h3>
<p>For the sake of this demo and to make things simpler, we will be using 2 models. It is generally prefered to use diverse models so that the meta model can provide superior predictions. Since our data can be used for the classification and regression tasks, we’ll use both to make an ensemble model and see how it performs.</p>
<p><strong>Instantiate our Models with parameters.</strong></p>
<p>Dffml makes it quite easy to load multiple models dynamically using the <code class="docutils literal notranslate"><span class="pre">Model.load()</span></code> function. All the entrypoints for models available in DFFML can be found at the <a class="reference internal" href="../../plugins/dffml_model.html"><span class="doc">Model Plugins Page</span></a>. After that, you just have to parameterize the loaded models and they are ready to train interchangably!</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Model1</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;scikitgnb&quot;</span><span class="p">)</span>
<span class="n">Model2</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;scikitridge&quot;</span><span class="p">)</span>

<span class="n">features</span> <span class="o">=</span> <span class="n">Features</span><span class="p">(</span>
    <span class="n">Feature</span><span class="p">(</span><span class="s2">&quot;fixed acidity&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">Feature</span><span class="p">(</span><span class="s2">&quot;volatile acidity&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">Feature</span><span class="p">(</span><span class="s2">&quot;citric acid&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">Feature</span><span class="p">(</span><span class="s2">&quot;residual sugar&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">Feature</span><span class="p">(</span><span class="s2">&quot;chlorides&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">Feature</span><span class="p">(</span><span class="s2">&quot;free sulfur dioxide&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">Feature</span><span class="p">(</span><span class="s2">&quot;total sulfur dioxide&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">Feature</span><span class="p">(</span><span class="s2">&quot;density&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">Feature</span><span class="p">(</span><span class="s2">&quot;pH&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">Feature</span><span class="p">(</span><span class="s2">&quot;sulphates&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">Feature</span><span class="p">(</span><span class="s2">&quot;alcohol&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">predict_feature</span> <span class="o">=</span> <span class="n">Feature</span><span class="p">(</span><span class="s2">&quot;quality&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">model1</span> <span class="o">=</span> <span class="n">Model1</span><span class="p">(</span>
    <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">predict</span><span class="o">=</span><span class="n">predict_feature</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s2">&quot;model1&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">model2</span> <span class="o">=</span> <span class="n">Model2</span><span class="p">(</span>
    <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">predict</span><span class="o">=</span><span class="n">predict_feature</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s2">&quot;model2&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p><strong>Train our Models</strong></p>
<p>Our models are ready to be trained using the <code class="docutils literal notranslate"><span class="pre">train()</span></code> function from the high-level API. Let’s make sure to pass each record as a parameter by simply using the unpacking operator(*).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">await</span> <span class="n">train</span><span class="p">(</span><span class="n">model1</span><span class="p">,</span> <span class="o">*</span><span class="n">train_data</span><span class="p">)</span>
<span class="k">await</span> <span class="n">train</span><span class="p">(</span><span class="n">model2</span><span class="p">,</span> <span class="o">*</span><span class="n">train_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p><strong>Test our Models</strong></p>
<p>Let’s see how well these models do on our test data.</p>
<p>To test our model, we’ll use the <code class="docutils literal notranslate"><span class="pre">accuracy()</span></code> function in the <code class="docutils literal notranslate"><span class="pre">high-level</span></code> API.</p>
<p>We ask for the accuracy to be assessed using the classification accuracy by passing “clf” to <code class="docutils literal notranslate"><span class="pre">AccuracyScorer.load()</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ClassificationAccuracy</span> <span class="o">=</span> <span class="n">AccuracyScorer</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;clf&quot;</span><span class="p">)</span>

<span class="n">scorer</span> <span class="o">=</span> <span class="n">ClassificationAccuracy</span><span class="p">()</span>

<span class="n">Accuracy1</span> <span class="o">=</span> <span class="k">await</span> <span class="n">score</span><span class="p">(</span><span class="n">model1</span><span class="p">,</span> <span class="n">scorer</span><span class="p">,</span> <span class="n">predict_feature</span><span class="p">,</span> <span class="o">*</span><span class="n">test_data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Accuracy of Model1:&quot;</span><span class="p">,</span> <span class="n">Accuracy1</span><span class="p">)</span>
<span class="n">Accuracy2</span> <span class="o">=</span> <span class="k">await</span> <span class="n">score</span><span class="p">(</span><span class="n">model2</span><span class="p">,</span> <span class="n">scorer</span><span class="p">,</span> <span class="n">predict_feature</span><span class="p">,</span> <span class="o">*</span><span class="n">test_data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Accuracy of Model2:&quot;</span><span class="p">,</span> <span class="n">Accuracy2</span><span class="p">)</span>
<span class="n">Accuracy</span> <span class="o">=</span> <span class="p">[</span><span class="n">Accuracy1</span><span class="p">,</span> <span class="n">Accuracy2</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Accuracy of Model1: 0.5451713395638629
Accuracy of Model2: 0.4735202492211838
</pre></div></div>
</div>
<p><strong>Visualize the Accuracies</strong></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">([</span><span class="s2">&quot;Model1&quot;</span><span class="p">,</span> <span class="s2">&quot;Model2&quot;</span><span class="p">],</span> <span class="n">Accuracy</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">Accuracy1</span><span class="p">,</span> <span class="n">Accuracy2</span><span class="p">]):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">v</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_notebooks_ensemble_by_stacking_22_0.png" src="../../_images/examples_notebooks_ensemble_by_stacking_22_0.png" />
</div>
</div>
<p>As expected, the classification model (<code class="docutils literal notranslate"><span class="pre">Model1</span></code>) performs way better than the regression model (<code class="docutils literal notranslate"><span class="pre">Model2</span></code>) on our data. What would happen if we ensemble these 2 models together? Will the emsemble be able to learn from our Classifier and Regressor and perform better overall? Let’s find out!</p>
<section id="2.-First-Level-Base-Model-predictions-on-Validation-data-and-Test-data.">
<h4>2. First-Level Base Model predictions on Validation data and Test data.<a class="headerlink" href="#2.-First-Level-Base-Model-predictions-on-Validation-data-and-Test-data." title="Permalink to this heading">¶</a></h4>
<p>Here, we will be using our models to predict on both the validation data and the test data, and save these predictions in lists. We will simply use the high-level <code class="docutils literal notranslate"><span class="pre">predict()</span></code> function to get the predictions and store these predictions in a list.</p>
<p><strong>Model1 Predictions</strong></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">validation_prediction_1</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">async</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="n">predict</span><span class="p">(</span><span class="n">model1</span><span class="p">,</span> <span class="o">*</span><span class="n">validation_data</span><span class="p">):</span>
    <span class="n">validation_prediction_1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prediction</span><span class="p">[</span><span class="s2">&quot;quality&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;First 5 Validation Predictions: &quot;</span><span class="p">,</span> <span class="n">validation_prediction_1</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>

<span class="n">test_prediction_1</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">async</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="n">predict</span><span class="p">(</span><span class="n">model1</span><span class="p">,</span> <span class="o">*</span><span class="n">test_data</span><span class="p">):</span>
    <span class="n">test_prediction_1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prediction</span><span class="p">[</span><span class="s2">&quot;quality&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;First 5 Test Predictions: &quot;</span><span class="p">,</span> <span class="n">test_prediction_1</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
First 5 Validation Predictions:  [5, 6, 5, 5, 7]
First 5 Test Predictions:  [5, 7, 5, 5, 6]
</pre></div></div>
</div>
<p><strong>Model2 Predictions</strong></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">validation_prediction_2</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">async</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="n">predict</span><span class="p">(</span><span class="n">model2</span><span class="p">,</span> <span class="o">*</span><span class="n">validation_data</span><span class="p">):</span>
    <span class="n">validation_prediction_2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prediction</span><span class="p">[</span><span class="s2">&quot;quality&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;First 5 Validation Predictions: &quot;</span><span class="p">,</span> <span class="n">validation_prediction_2</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>

<span class="n">test_prediction_2</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">async</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="n">predict</span><span class="p">(</span><span class="n">model2</span><span class="p">,</span> <span class="o">*</span><span class="n">test_data</span><span class="p">):</span>
    <span class="n">test_prediction_2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prediction</span><span class="p">[</span><span class="s2">&quot;quality&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;First 5 Test Predictions: &quot;</span><span class="p">,</span> <span class="n">test_prediction_2</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
First 5 Validation Predictions:  [5, 6, 5, 5, 6]
First 5 Test Predictions:  [4, 6, 5, 5, 5]
</pre></div></div>
</div>
</section>
<section id="3.-Stack-Predictions.">
<h4>3. Stack Predictions.<a class="headerlink" href="#3.-Stack-Predictions." title="Permalink to this heading">¶</a></h4>
<p>Now, we will stack all the validation predictions together into a list of dictionaries, and test predictions into another list of dictionaries. After this, we will have 2 lists consisting of stacked validation predictions and stacked test predictions.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">validation_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">features</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;fixed acidity&#39;: 8,
 &#39;volatile acidity&#39;: 0.59,
 &#39;citric acid&#39;: 0.05,
 &#39;residual sugar&#39;: 2,
 &#39;chlorides&#39;: 0.089,
 &#39;free sulfur dioxide&#39;: 12,
 &#39;total sulfur dioxide&#39;: 32,
 &#39;density&#39;: 0.99735,
 &#39;pH&#39;: 3.36,
 &#39;sulphates&#39;: 0.61,
 &#39;alcohol&#39;: 10,
 &#39;quality&#39;: 5}
</pre></div></div>
</div>
<p>We can use the ground truth values saved in our records as the feature <code class="docutils literal notranslate"><span class="pre">&quot;quality&quot;</span></code>, to stack with the predictions as our <code class="docutils literal notranslate"><span class="pre">'y'</span></code> variable.</p>
<p><strong>Stacked Validation Predictions</strong></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stacked_validation_predictions</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">n_record</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">validation_data</span><span class="p">)):</span>
    <span class="n">stacked_validation_predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;x1&quot;</span><span class="p">:</span> <span class="n">validation_prediction_1</span><span class="p">[</span><span class="n">n_record</span><span class="p">],</span>
            <span class="s2">&quot;x2&quot;</span><span class="p">:</span> <span class="n">validation_prediction_2</span><span class="p">[</span><span class="n">n_record</span><span class="p">],</span>
            <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">validation_data</span><span class="p">[</span><span class="n">n_record</span><span class="p">]</span><span class="o">.</span><span class="n">feature</span><span class="p">(</span><span class="s2">&quot;quality&quot;</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="p">)</span>
<span class="n">stacked_validation_predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[{&#39;x1&#39;: 5, &#39;x2&#39;: 5, &#39;y&#39;: 5},
 {&#39;x1&#39;: 6, &#39;x2&#39;: 6, &#39;y&#39;: 6},
 {&#39;x1&#39;: 5, &#39;x2&#39;: 5, &#39;y&#39;: 5},
 {&#39;x1&#39;: 5, &#39;x2&#39;: 5, &#39;y&#39;: 5},
 {&#39;x1&#39;: 7, &#39;x2&#39;: 6, &#39;y&#39;: 6}]
</pre></div></div>
</div>
<p><strong>Stacked Test Predictions</strong></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stacked_test_predictions</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">n_record</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_data</span><span class="p">)):</span>
    <span class="n">stacked_test_predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;x1&quot;</span><span class="p">:</span> <span class="n">test_prediction_1</span><span class="p">[</span><span class="n">n_record</span><span class="p">],</span>
            <span class="s2">&quot;x2&quot;</span><span class="p">:</span> <span class="n">test_prediction_2</span><span class="p">[</span><span class="n">n_record</span><span class="p">],</span>
            <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">test_data</span><span class="p">[</span><span class="n">n_record</span><span class="p">]</span><span class="o">.</span><span class="n">feature</span><span class="p">(</span><span class="s2">&quot;quality&quot;</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="p">)</span>
<span class="n">stacked_test_predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[{&#39;x1&#39;: 5, &#39;x2&#39;: 4, &#39;y&#39;: 6},
 {&#39;x1&#39;: 7, &#39;x2&#39;: 6, &#39;y&#39;: 7},
 {&#39;x1&#39;: 5, &#39;x2&#39;: 5, &#39;y&#39;: 6},
 {&#39;x1&#39;: 5, &#39;x2&#39;: 5, &#39;y&#39;: 6},
 {&#39;x1&#39;: 6, &#39;x2&#39;: 5, &#39;y&#39;: 6}]
</pre></div></div>
</div>
</section>
<section id="4.-Build-and-Train-Level-2-Meta-Model.">
<h4>4. Build and Train Level-2 Meta-Model.<a class="headerlink" href="#4.-Build-and-Train-Level-2-Meta-Model." title="Permalink to this heading">¶</a></h4>
<p>The stacked validation predictions will serve as features to our level-2 meta-model. Classifiers clearly outperform regressors on the data we are using, so let’s also use a classifier for our meta model. For this demo, we will use the Scikit SVC model available in DFFML by the entrypoint <code class="docutils literal notranslate"><span class="pre">&quot;scikitsvc&quot;</span></code>.</p>
<p><strong>Build and train the meta-model</strong></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">metaModel</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;scikitsvc&quot;</span><span class="p">)</span>

<span class="n">features</span> <span class="o">=</span> <span class="n">Features</span><span class="p">(</span><span class="n">Feature</span><span class="p">(</span><span class="s2">&quot;x1&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">Feature</span><span class="p">(</span><span class="s2">&quot;x2&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="mi">1</span><span class="p">),)</span>
<span class="n">predict_feature</span> <span class="o">=</span> <span class="n">Feature</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">metaModel</span> <span class="o">=</span> <span class="n">metaModel</span><span class="p">(</span>
    <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">predict</span><span class="o">=</span> <span class="n">predict_feature</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s2">&quot;metaModel&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">await</span> <span class="n">train</span><span class="p">(</span><span class="n">metaModel</span><span class="p">,</span> <span class="o">*</span><span class="n">stacked_validation_predictions</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">EnsembleAcc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">score</span><span class="p">(</span><span class="n">metaModel</span><span class="p">,</span> <span class="n">scorer</span><span class="p">,</span> <span class="n">predict_feature</span><span class="p">,</span> <span class="o">*</span><span class="n">stacked_test_predictions</span><span class="p">)</span>
<span class="n">Accuracy</span> <span class="o">=</span> <span class="p">[</span><span class="n">Accuracy1</span><span class="p">,</span> <span class="n">Accuracy2</span><span class="p">,</span> <span class="n">EnsembleAcc</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Accuracy of Ensemble Model:&quot;</span><span class="p">,</span> <span class="n">EnsembleAcc</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Accuracy of Ensemble Model: 0.5763239875389408
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Accuracy</span> <span class="o">=</span> <span class="p">[</span><span class="n">Accuracy1</span><span class="p">,</span> <span class="n">Accuracy2</span><span class="p">,</span> <span class="n">EnsembleAcc</span><span class="p">]</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">([</span><span class="s2">&quot;Model1&quot;</span><span class="p">,</span> <span class="s2">&quot;Model2&quot;</span><span class="p">,</span> <span class="s2">&quot;Ensemble Model&quot;</span><span class="p">],</span> <span class="n">Accuracy</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Accuracy</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">v</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_notebooks_ensemble_by_stacking_37_0.png" src="../../_images/examples_notebooks_ensemble_by_stacking_37_0.png" />
</div>
</div>
<p>Our experiment was a success! It turns out the Ensemble model was after all able to learn somthing from not only the classifier but the regressor as well, and performed better than both. Feel free to download the notebook and tune the models to get even better accuracies.</p>
</section>
<section id="5.-Final-Prediction">
<h4>5. Final Prediction<a class="headerlink" href="#5.-Final-Prediction" title="Permalink to this heading">¶</a></h4>
<p>Now our ensembled model is ready to perform the final predictions. We can simply go ahead and predict on stacked test predictions to get the final predcitions.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">final_predictions</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">async</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="n">predict</span><span class="p">(</span><span class="n">metaModel</span><span class="p">,</span> <span class="o">*</span><span class="n">stacked_test_predictions</span><span class="p">):</span>
    <span class="n">final_predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prediction</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;First 5 Final Predictions: &quot;</span><span class="p">,</span> <span class="n">test_prediction_2</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
First 5 Final Predictions:  [4, 6, 5, 5, 5]
</pre></div></div>
</div>
</section>
</section>
</section>
</section>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="transferlearning.html" class="btn btn-neutral float-right" title="Transfer Learning" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="saving_and_loading_models.html" class="btn btn-neutral float-left" title="Saving and loading models" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2017 - 2022, Intel.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>