

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>InnerSource Portal &mdash; DFFML 5b53a7dbe documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/tabs.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="InnerSource Microservice" href="microservice.html" />
    <link rel="prev" title="InnerSource" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> DFFML
          

          
          </a>

          
            
            
              <div class="version">
                5b53a7dbe
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../concepts/index.html">Concepts</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Usage</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../quickstart/model.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../notebooks/index.html">Notebooks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integration.html">Automating Classification</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shouldi.html">Meta Static Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dataflows.html">DataFlow HTTP Deployment</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">InnerSource</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">InnerSource Portal</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#history">History</a></li>
<li class="toctree-l4"><a class="reference internal" href="#frontend">Frontend</a></li>
<li class="toctree-l4"><a class="reference internal" href="#crawler">Crawler</a></li>
<li class="toctree-l4"><a class="reference internal" href="#constraints">Constraints</a></li>
<li class="toctree-l4"><a class="reference internal" href="#architecture">Architecture</a></li>
<li class="toctree-l4"><a class="reference internal" href="#implementation-plan">Implementation Plan</a></li>
<li class="toctree-l4"><a class="reference internal" href="#input-data">Input Data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#reading-inputs">Reading Inputs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#writing-outputs">Writing Outputs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#querying-github">Querying GitHub</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dataflow">DataFlow</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="microservice.html">InnerSource Microservice</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../mnist.html">MNIST Handwriten Digits</a></li>
<li class="toctree-l2"><a class="reference internal" href="../flower17/flower17.html">Flower17 Species Classification</a></li>
<li class="toctree-l2"><a class="reference internal" href="../or_covid_data_by_county.html">COVID Forecasting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webhook/index.html">Continuous Deployment of DataFlows</a></li>
<li class="toctree-l2"><a class="reference internal" href="../icecream_sales.html">Ice Cream Sales</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data_cleanup/index.html">Data Cleanup</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../plugins/index.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli.html">Command Line</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plugins/service/http/index.html">HTTP API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/base.html">Base</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/log.html">Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/noasync.html">Noasync</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/plugins.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/record.html">Record</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/version.html">Version</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/db/index.html">Db</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/cli/index.html">Cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/df/index.html">Df</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/high_level/index.html">High_Level</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/tuner/index.html">Tuner</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/service/index.html">Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/util/index.html">Util</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/configloader/index.html">Configloader</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/accuracy/index.html">Accuracy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/source/index.html">Source</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/operation/index.html">Operation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/model/index.html">Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/secret/index.html">Secret</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/port/index.html">Port</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/feature/index.html">Feature</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../arch/index.html">Architecture</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Subprojects</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../shouldi.html">shouldi</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Community</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/intel/dffml">GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://intel.github.io/dffml/main/">Master Branch Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../publications.html">Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contact.html">Contact Us</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/index.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../news/index.html">News</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">DFFML</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Examples</a> &raquo;</li>
        
          <li><a href="index.html">InnerSource</a> &raquo;</li>
        
      <li>InnerSource Portal</li>
    
    


      <li class="wy-breadcrumbs-aside">
        
          
            
              <a href="https://github.com/intel/dffml/blob/main/docs/examples/innersource/swportal.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    


  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="innersource-portal">
<h1>InnerSource Portal<a class="headerlink" href="#innersource-portal" title="Permalink to this heading">¶</a></h1>
<p>Example of using DFFML to create a web app to discover information about
software. The purpose of this example is to write an application using
dataflows. We’ll show how a dataflow based architecture results in a
software development workflow that makes is easy for a large group of developers
to collaborate quickly and effectively.</p>
<p>All the code for this example project is located under the
<a class="reference external" href="https://github.com/intel/dffml/blob/main/examples/innersource/swportal/">examples/innersource/swportal</a>
directory of the DFFML source code.</p>
<section id="history">
<h2>History<a class="headerlink" href="#history" title="Permalink to this heading">¶</a></h2>
<p>DFFML was initially developed for use in an allowlist tool. The allowlist tool
was similar to the InnerSource portal in that it collected and displayed metrics
on software projects. It also ran those collected metrics through a machine
learning model to assign a classification to the projects.</p>
<p>The “Down the Dependency Rabbit Hole” talk from BSides PDX 2019 provides more
detail on this history and architecture. The following link will skip to the
metric gathering portion of the presentation which is the part of the talk most
relevant to this example.
<a class="reference external" href="https://www.youtube.com/watch?v=D9puJiKKKS8&amp;t=328s">https://www.youtube.com/watch?v=D9puJiKKKS8&amp;t=328s</a></p>
</section>
<section id="frontend">
<h2>Frontend<a class="headerlink" href="#frontend" title="Permalink to this heading">¶</a></h2>
<p>We’ll be leveraging the InnerSource portal built by SAP
<a class="reference external" href="https://github.com/SAP/project-portal-for-innersource">https://github.com/SAP/project-portal-for-innersource</a> as our frontend.</p>
<p>You need to have nodejs installed (and <code class="docutils literal notranslate"><span class="pre">yarn</span></code>, or can replace it with <code class="docutils literal notranslate"><span class="pre">npm</span></code>)
before you can run the following commands.</p>
<img alt="Screenshot of SAP InnerSource portal showing grid of projects" src="https://github.com/SAP/project-portal-for-innersource/raw/main/docs/overview.png" />
<p>We need to download the code first for the portal first. We’ll be working from a
snapshot so you’ll see a long string of hex which is the git commit. We download
the code and rename the downloaded directory to <code class="docutils literal notranslate"><span class="pre">html-client</span></code>.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>curl -sfL <span class="s1">&#39;https://github.com/SAP/project-portal-for-innersource/archive/8a328cf30f5626b3658577b223d990af6285c272.tar.gz&#39;</span> <span class="p">|</span> tar -xvz
<span class="gp">$ </span>mv project-portal-for-innersource-8a328cf30f5626b3658577b223d990af6285c272 html-client
</pre></div>
</div>
<p>Now we go into the html-client directory, install the depenedencies, and start
the server.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">cd</span> html-client
<span class="gp">$ </span>yarn install
<span class="go">yarn install v1.22.5</span>
<span class="go">info No lockfile found.</span>
<span class="go">[1/4] Resolving packages...</span>
<span class="go">[2/4] Fetching packages...</span>
<span class="go">[3/4] Linking dependencies...</span>
<span class="go">[4/4] Building fresh packages...</span>
<span class="go">success Saved lockfile.</span>
<span class="go">Done in 2.38s.</span>
<span class="gp">$ </span>yarn start
<span class="go">yarn run v1.22.5</span>
<span class="go">Starting up http-server, serving.</span>
<span class="go">Available on:</span>
<span class="go">  http://127.0.0.1:8080</span>
<span class="go">Hit CTRL-C to stop the server</span>
</pre></div>
</div>
<p>Now open a new terminal, make sure you’re in the directory we started in, so
that <code class="docutils literal notranslate"><span class="pre">html-client</span></code> is a subdirectory. You may need to change directory to the
parent directory.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">cd</span> ..
<span class="gp">$ </span>ls -l
</pre></div>
</div>
</section>
<section id="crawler">
<h2>Crawler<a class="headerlink" href="#crawler" title="Permalink to this heading">¶</a></h2>
<p>This tutorial focuses on building the “crawler”, which is the code that grabs
metrics on each project in the portal.</p>
<p>The crawler is responsible for generating the metrics seen on each project modal
popup.</p>
<p>You can read more about what the expectations for the crawler are here:
<a class="reference external" href="https://github.com/SAP/project-portal-for-innersource/blob/main/docs/CRAWLING.md">https://github.com/SAP/project-portal-for-innersource/blob/main/docs/CRAWLING.md</a></p>
<img alt="Screenshot of SAP InnerSource portal showing project details popup" src="https://github.com/SAP/project-portal-for-innersource/raw/main/docs/details.png" />
</section>
<section id="constraints">
<h2>Constraints<a class="headerlink" href="#constraints" title="Permalink to this heading">¶</a></h2>
<p>We have a number of constraints for this example.</p>
<ul class="simple">
<li><p>The repos we are interested in displaying are all hosted in GitHub. We can
find the information we need stored on the file system. (See the
<a class="reference external" href="https://github.com/intel/dffml/blob/main/examples/innersource/swportal/orgs/">orgs</a>
directory to see what this looks like).</p></li>
</ul>
<blockquote>
<div><ul class="simple">
<li><p>The structure is such that GitHub orgs are directories. Each directory
has a <code class="docutils literal notranslate"><span class="pre">repos.yml</span></code> file in it. There may be multiple YAML documents per
file. Each YAML document gives the repo name and the repo owners.</p></li>
</ul>
</div></blockquote>
<ul class="simple">
<li><p>Different repo owners will want to collect and display different metrics in
their project’s detail page.</p>
<ul>
<li><p>We want to make is easy for developers to reuse existing code and data when
collecting new metrics.</p></li>
<li><p>We’ll use DataFlows to collect metrics</p></li>
</ul>
</li>
<li><p>We must output in <a class="reference external" href="https://github.com/SAP/project-portal-for-innersource/blob/main/repos.json">repos.json</a>
format that the SAP portal frontend knows how to consume.</p></li>
</ul>
</section>
<section id="architecture">
<h2>Architecture<a class="headerlink" href="#architecture" title="Permalink to this heading">¶</a></h2>
<p>The following diagram shows the high level architecture of a crawler that
satisfies our constraints.</p>
<img alt="Flow chart showing high level architechture where we read the repos.yml files run the dataflow on each repo, then save to the repos.json source." src="../../_images/swportal-high-level-architecture.svg" /></section>
<section id="implementation-plan">
<h2>Implementation Plan<a class="headerlink" href="#implementation-plan" title="Permalink to this heading">¶</a></h2>
<p>We’ll be leveraging three major DFFML concepts as we implement our crawler.
These are Sources, and DataFlows &amp; Operations.</p>
<ul class="simple">
<li><p>The input <code class="docutils literal notranslate"><span class="pre">repo.yml</span></code> files and the output <code class="docutils literal notranslate"><span class="pre">repos.json</span></code> file are ideal
candidates for DFFML Sources.</p>
<ul>
<li><p>A Source in DFFML is anything containing records which can be referenced by
a unique identifier.</p></li>
<li><p>A GitHub repo can be uniquely identified by it’s organization / user and
it’s name.</p></li>
</ul>
</li>
<li><p>Collecting a dataset, in this case metrics for a given repo, is a job for a
DataFlow.</p>
<ul>
<li><p>We can combine many different Operations together to collect metrics.</p></li>
<li><p>We’re going to query GitHub for some metrics / data.</p></li>
<li><p>We’re going to re-use metric gathers from the allowlist tool.</p></li>
</ul>
</li>
</ul>
</section>
<section id="input-data">
<h2>Input Data<a class="headerlink" href="#input-data" title="Permalink to this heading">¶</a></h2>
<p>Let’s create the <code class="docutils literal notranslate"><span class="pre">orgs/</span></code> directory, and two subdirectories. One for the
<code class="docutils literal notranslate"><span class="pre">intel</span></code> GitHub organization, and one for the <code class="docutils literal notranslate"><span class="pre">tpm2-software</span></code> organization.
These directories will contain the <code class="docutils literal notranslate"><span class="pre">repos.yml</span></code> files.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>mkdir orgs/
<span class="gp">$ </span>mkdir orgs/intel/
<span class="gp">$ </span>mkdir orgs/tpm2-software/
</pre></div>
</div>
<p>Create the following files. For the sake of this example, the YAML file format
we’re working with has multiple YAML documents per file, separated with <code class="docutils literal notranslate"><span class="pre">---</span></code>.
Each document represents a GitHub repo. Each document gives the name of the repo
and the repo owners.</p>
<p><strong>orgs/intel/repos.yml</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---</span>
<span class="n">name</span><span class="p">:</span> <span class="n">dffml</span>
<span class="n">owners</span><span class="p">:</span>
<span class="o">-</span> <span class="n">johnandersenpdx</span><span class="nd">@gmail</span><span class="o">.</span><span class="n">com</span>
<span class="o">---</span>
<span class="n">name</span><span class="p">:</span> <span class="n">cve</span><span class="o">-</span><span class="nb">bin</span><span class="o">-</span><span class="n">tool</span>
<span class="n">owners</span><span class="p">:</span>
<span class="o">-</span> <span class="n">terri</span><span class="nd">@toybox</span><span class="o">.</span><span class="n">ca</span>
</pre></div>
</div>
<p><strong>orgs/tpm2-software/repos.yml</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---</span>
<span class="n">name</span><span class="p">:</span> <span class="n">tpm2</span><span class="o">-</span><span class="n">pkcs11</span>
<span class="n">owners</span><span class="p">:</span>
<span class="o">-</span> <span class="n">william</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">roberts</span><span class="nd">@intel</span><span class="o">.</span><span class="n">com</span>
<span class="o">---</span>
<span class="n">name</span><span class="p">:</span> <span class="n">tpm2</span><span class="o">-</span><span class="n">tools</span>
<span class="n">owners</span><span class="p">:</span>
<span class="o">-</span> <span class="n">imran</span><span class="o">.</span><span class="n">desai</span><span class="nd">@intel</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
</section>
<section id="reading-inputs">
<h2>Reading Inputs<a class="headerlink" href="#reading-inputs" title="Permalink to this heading">¶</a></h2>
<p>Create a directory where we’ll store all of the sources (Python classes)
we’ll use to read and write repo data / metrics.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>mkdir sources/
</pre></div>
</div>
<p>Install the PyYAML library, which we’ll use to parse the YAML files.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>python -m pip install PyYAML
</pre></div>
</div>
<p>We’ll implement a DFFML Source for the <code class="docutils literal notranslate"><span class="pre">repos.yml</span></code> files which live under
directories named after their respective GitHub orgs.</p>
<p>We’ll back the repos in memory when we load them in, and don’t need to support
writing them back out for this source.</p>
<p><strong>TOOD</strong> See <a class="reference external" href="https://youtu.be/VogNhBMmsNk">https://youtu.be/VogNhBMmsNk</a> for more details on implemention until
this section gets further writing.</p>
<p><strong>sources/orgs_repos_yml.py</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">pathlib</span>

<span class="kn">from</span> <span class="nn">dffml</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">config</span><span class="p">,</span>
    <span class="n">field</span><span class="p">,</span>
    <span class="n">Record</span><span class="p">,</span>
    <span class="n">MemorySource</span><span class="p">,</span>
    <span class="n">entrypoint</span><span class="p">,</span>
    <span class="n">Record</span><span class="p">,</span>
    <span class="n">MemorySource</span><span class="p">,</span>
<span class="p">)</span>


<span class="nd">@config</span>
<span class="k">class</span> <span class="nc">OrgsReposYAMLSourceConfig</span><span class="p">:</span>
    <span class="n">directory</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
        <span class="s2">&quot;Top level directory containing GitHub orgs as subdirectories&quot;</span>
    <span class="p">)</span>


<span class="nd">@entrypoint</span><span class="p">(</span><span class="s2">&quot;orgs.repos.yml&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">OrgsReposYAMLSource</span><span class="p">(</span><span class="n">MemorySource</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads from a SAP InnerSource Portal repos.json format. Each repo&#39;s</span>
<span class="sd">    data is stored as Record feature data in memory.</span>

<span class="sd">    Writing not implemented.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">OrgsReposYAMLSourceConfig</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__aenter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Populate the source when it&#39;s context is entered</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">yaml_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">directory</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&quot;*.yml&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load_all</span><span class="p">(</span><span class="n">yaml_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">()):</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;https://github.com/</span><span class="si">{</span><span class="n">yaml_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">doc</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">Record</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="n">doc</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> loaded </span><span class="si">%d</span><span class="s2"> records&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span>
</pre></div>
</div>
<p>We list all the records for a source using the DFFML command line and the Python
entry point path to the class we just implemented
(<code class="docutils literal notranslate"><span class="pre">module.submodule:ClassName</span></code>). Each repo is a record.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>dffml list records <span class="se">\</span>
    -sources <span class="nv">orgs</span><span class="o">=</span>sources.orgs_repos_yml:OrgsReposYAMLSource <span class="se">\</span>
    -source-orgs-directory orgs/
<span class="go">[</span>
<span class="go">    {</span>
<span class="go">        &quot;extra&quot;: {},</span>
<span class="go">        &quot;features&quot;: {</span>
<span class="go">            &quot;name&quot;: &quot;dffml&quot;,</span>
<span class="go">            &quot;owners&quot;: [</span>
<span class="go">                &quot;johnandersenpdx@gmail.com&quot;</span>
<span class="go">            ]</span>
<span class="go">        },</span>
<span class="go">        &quot;key&quot;: &quot;https://github.com/intel/dffml&quot;</span>
<span class="go">    },</span>
<span class="go">    {</span>
<span class="go">        &quot;extra&quot;: {},</span>
<span class="go">        &quot;features&quot;: {</span>
<span class="go">            &quot;name&quot;: &quot;cve-bin-tool&quot;,</span>
<span class="go">            &quot;owners&quot;: [</span>
<span class="go">                &quot;terri@toybox.ca&quot;</span>
<span class="go">            ]</span>
<span class="go">        },</span>
<span class="go">        &quot;key&quot;: &quot;https://github.com/intel/cve-bin-tool&quot;</span>
<span class="go">    },</span>
<span class="go">    {</span>
<span class="go">        &quot;extra&quot;: {},</span>
<span class="go">        &quot;features&quot;: {</span>
<span class="go">            &quot;name&quot;: &quot;tpm2-pkcs11&quot;,</span>
<span class="go">            &quot;owners&quot;: [</span>
<span class="go">                &quot;william.c.roberts@intel.com&quot;</span>
<span class="go">            ]</span>
<span class="go">        },</span>
<span class="go">        &quot;key&quot;: &quot;https://github.com/tpm2-software/tpm2-pkcs11&quot;</span>
<span class="go">    },</span>
<span class="go">    {</span>
<span class="go">        &quot;extra&quot;: {},</span>
<span class="go">        &quot;features&quot;: {</span>
<span class="go">            &quot;name&quot;: &quot;tpm2-tools&quot;,</span>
<span class="go">            &quot;owners&quot;: [</span>
<span class="go">                &quot;imran.desai@intel.com&quot;</span>
<span class="go">            ]</span>
<span class="go">        },</span>
<span class="go">        &quot;key&quot;: &quot;https://github.com/tpm2-software/tpm2-tools&quot;</span>
<span class="go">    }</span>
<span class="go">]</span>
</pre></div>
</div>
</section>
<section id="writing-outputs">
<h2>Writing Outputs<a class="headerlink" href="#writing-outputs" title="Permalink to this heading">¶</a></h2>
<p>We also need to implement DFFML Source for the <code class="docutils literal notranslate"><span class="pre">repos.json</span></code> file which is in
the format that the frontend knows how to display.</p>
<p>The builtin DFFML JSON format source outputs an object, whereas the frontend
expects an array. So we need to dump the Record feature data (which is where we
put the metrics and repo information), to and from the file.</p>
<p>We’ll implement both reading and writing for this source, so that we can verify
it works easily via reading. Also because it’s easy enough to implement since
we’ll be subclassing from the <code class="docutils literal notranslate"><span class="pre">FileSource</span></code> and <code class="docutils literal notranslate"><span class="pre">MemorySource</span></code> which means we
only have to implement loading from the file descriptor (<code class="docutils literal notranslate"><span class="pre">fd</span></code>) and saving back
to it.</p>
<p><strong>TOOD</strong> See <a class="reference external" href="https://youtu.be/VogNhBMmsNk">https://youtu.be/VogNhBMmsNk</a> for more details on implemention until
this section gets further writing.</p>
<p><strong>sources/sap_portal_repos_json.py</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">dffml</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">export</span><span class="p">,</span>
    <span class="n">Record</span><span class="p">,</span>
    <span class="n">MemorySource</span><span class="p">,</span>
    <span class="n">entrypoint</span><span class="p">,</span>
    <span class="n">Record</span><span class="p">,</span>
    <span class="n">MemorySource</span><span class="p">,</span>
    <span class="n">FileSource</span><span class="p">,</span>
    <span class="n">FileSourceConfig</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">class</span> <span class="nc">SAPPortalReposJSONSourceConfig</span><span class="p">(</span><span class="n">FileSourceConfig</span><span class="p">):</span>
    <span class="k">pass</span>  <span class="c1"># pragma: no cov</span>


<span class="nd">@entrypoint</span><span class="p">(</span><span class="s2">&quot;sap.portal.repos.json&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">SAPPortalReposJSONSource</span><span class="p">(</span><span class="n">FileSource</span><span class="p">,</span> <span class="n">MemorySource</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads and write from a SAP InnerSource Portal repos.json format. Each repo&#39;s</span>
<span class="sd">    data is stored as Record feature data in memory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">SAPPortalReposJSONSourceConfig</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">load_fd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fd</span><span class="p">):</span>
        <span class="c1"># No predictions here, each repo&#39;s data is treated as a record with only</span>
        <span class="c1"># feature data.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mem</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">record</span><span class="p">[</span><span class="s2">&quot;html_url&quot;</span><span class="p">]:</span> <span class="n">Record</span><span class="p">(</span>
                <span class="n">record</span><span class="p">[</span><span class="s2">&quot;html_url&quot;</span><span class="p">],</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="n">record</span><span class="p">}</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> loaded </span><span class="si">%d</span><span class="s2"> records&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">dump_fd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fd</span><span class="p">):</span>
        <span class="c1"># Dump all records to the array format</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span>
            <span class="p">[</span><span class="n">export</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">features</span><span class="p">())</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span> <span class="n">fd</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> saved </span><span class="si">%d</span><span class="s2"> records&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="p">))</span>
</pre></div>
</div>
<p>Try listing all the records in the new source to verify it works.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>dffml list records <span class="se">\</span>
    -sources <span class="nv">portal</span><span class="o">=</span>sources.sap_portal_repos_json:SAPPortalReposJSONSource <span class="se">\</span>
    -source-portal-filename html-client/repos.json
<span class="go">[</span>
<span class="go">    {</span>
<span class="go">        &quot;extra&quot;: {},</span>
<span class="go">        &quot;features&quot;: {</span>
<span class="go">            &quot;_InnerSourceMetadata&quot;: {</span>
<span class="go">                &quot;logo&quot;: &quot;./images/demo/Earth.png&quot;,</span>
<span class="go">                &quot;participation&quot;: [</span>
<span class="go">                    15,</span>
<span class="go">                    3,</span>
<span class="go">                    7,</span>
<span class="go">                    2,</span>
<span class="go">                    7,</span>
<span class="go">                    6,</span>
<span class="go">                    11,</span>
<span class="go">                    4,</span>
<span class="go">                    9,</span>
<span class="go">                    11,</span>
<span class="go">                    4,</span>
<span class="go">                    0,</span>
<span class="go">                    4,</span>
<span class="go">                    6,</span>
<span class="go">                    3,</span>
<span class="go">                    2,</span>
<span class="go">                    6,</span>
<span class="go">                    4,</span>
<span class="go">                    3,</span>
<span class="go">                    5,</span>
<span class="go">                    9,</span>
<span class="go">                    1,</span>
<span class="go">                    2,</span>
<span class="go">                    2,</span>
<span class="go">                    7,</span>
<span class="go">                    6,</span>
<span class="go">                    7,</span>
<span class="go">                    25,</span>
<span class="go">                    9,</span>
<span class="go">                    7,</span>
<span class="go">                    9,</span>
<span class="go">                    10,</span>
<span class="go">                    7,</span>
<span class="go">                    3,</span>
<span class="go">                    8,</span>
<span class="go">                    10,</span>
<span class="go">                    13,</span>
<span class="go">                    6,</span>
<span class="go">                    5,</span>
<span class="go">                    4,</span>
<span class="go">                    9,</span>
<span class="go">                    6,</span>
<span class="go">                    8,</span>
<span class="go">                    8,</span>
<span class="go">                    10,</span>
<span class="go">                    3,</span>
<span class="go">                    3,</span>
<span class="go">                    6,</span>
<span class="go">                    2,</span>
<span class="go">                    8,</span>
<span class="go">                    12,</span>
<span class="go">                    8</span>
<span class="go">                ],</span>
<span class="go">                &quot;score&quot;: 3900,</span>
<span class="go">                &quot;topics&quot;: [</span>
<span class="go">                    &quot;earth&quot;,</span>
<span class="go">                    &quot;JavaScript&quot;,</span>
<span class="go">                    &quot;Sol&quot;</span>
<span class="go">                ]</span>
<span class="go">            },</span>
<span class="go">            &quot;created_at&quot;: &quot;2017-01-31T09:39:12Z&quot;,</span>
<span class="go">            &quot;default_branch&quot;: &quot;main&quot;,</span>
<span class="go">            &quot;description&quot;: &quot;Earth is the third planet from the Sun and the home-world of humanity.&quot;,</span>
<span class="go">            &quot;forks_count&quot;: 331,</span>
<span class="go">            &quot;full_name&quot;: &quot;Sol/earth&quot;,</span>
<span class="go">            &quot;html_url&quot;: &quot;https://github.instance/Sol/earth&quot;,</span>
<span class="go">            &quot;id&quot;: 2342,</span>
<span class="go">            &quot;language&quot;: &quot;JavaScript&quot;,</span>
<span class="go">            &quot;license&quot;: null,</span>
<span class="go">            &quot;name&quot;: &quot;earth&quot;,</span>
<span class="go">            &quot;open_issues_count&quot;: 98,</span>
<span class="go">            &quot;owner&quot;: {</span>
<span class="go">                &quot;avatar_url&quot;: &quot;./images/demo/Sol.png&quot;,</span>
<span class="go">                &quot;login&quot;: &quot;Sol&quot;</span>
<span class="go">            },</span>
<span class="go">            &quot;pushed_at&quot;: &quot;2020-10-08T12:18:22Z&quot;,</span>
<span class="go">            &quot;stargazers_count&quot;: 136,</span>
<span class="go">            &quot;updated_at&quot;: &quot;2020-10-07T09:42:53Z&quot;,</span>
<span class="go">            &quot;watchers_count&quot;: 136</span>
<span class="go">        },</span>
<span class="go">        &quot;key&quot;: &quot;https://github.instance/Sol/earth&quot;</span>
<span class="go">    },</span>
<span class="go">    &lt;... output clipped ...&gt;</span>
</pre></div>
</div>
</section>
<section id="querying-github">
<h2>Querying GitHub<a class="headerlink" href="#querying-github" title="Permalink to this heading">¶</a></h2>
<p>Create a directory where we’ll store all of the operations (Python functions)
we’ll use to gather project data / metrics.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>mkdir operations/
</pre></div>
</div>
<p>Make it a Python module by creating a blank <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> file in it.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>touch operations/__init__.py
</pre></div>
</div>
<p>Install the PyGithub library, which we’ll use to access the GitHub API.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>python -m pip install PyGithub
</pre></div>
</div>
<p>You’ll need a Personal Access Token to be able to make calls to GitHub’s API.
You can create one by following their documentation.</p>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.github.com/en/github/authenticating-to-github/creating-a-personal-access-token">https://docs.github.com/en/github/authenticating-to-github/creating-a-personal-access-token</a></p></li>
</ul>
<p>When it presents you with a bunch of checkboxes for difference “scopes” you
don’t have to check any of them, unless you want to access your own private
repos, then check the repos box.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">export</span> <span class="nv">GITHUB_TOKEN</span><span class="o">=</span>&lt;paste your personal access token here&gt;
</pre></div>
</div>
<p>You’ve just pasted your token into your terminal so it will likely show up in
your shell’s history. You might want to either remove it from your history, or
just delete the token on GitHub’s settings page after you’re done with this
tutorial.</p>
<p>Write a Python function which returns an object representing a GitHub repo. For
simplicity of this tutorial, the function will take the token from the
environment variable we just set.</p>
<p><strong>operations/gh.py</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">dffml</span>
<span class="kn">import</span> <span class="nn">github</span>


<span class="nd">@dffml</span><span class="o">.</span><span class="n">op</span><span class="p">(</span>
    <span class="n">inputs</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">dffml</span><span class="o">.</span><span class="n">Definition</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;github.repo.url&quot;</span><span class="p">,</span> <span class="n">primitive</span><span class="o">=</span><span class="s2">&quot;string&quot;</span><span class="p">),</span>
    <span class="p">},</span>
    <span class="n">outputs</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="n">dffml</span><span class="o">.</span><span class="n">Definition</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;github.org.owner_name&quot;</span><span class="p">,</span> <span class="n">primitive</span><span class="o">=</span><span class="s2">&quot;string&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;project&quot;</span><span class="p">:</span> <span class="n">dffml</span><span class="o">.</span><span class="n">Definition</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;github.repo.project_name&quot;</span><span class="p">,</span> <span class="n">primitive</span><span class="o">=</span><span class="s2">&quot;string&quot;</span>
        <span class="p">),</span>
    <span class="p">},</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">github_split_owner_project</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses the owner and project name out of a GitHub URL</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; github_split_owner_project(&quot;https://github.com/intel/dffml&quot;)</span>
<span class="sd">    (&#39;intel&#39;, &#39;dffml&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="nb">zip</span><span class="p">(</span>
            <span class="p">(</span><span class="s2">&quot;owner&quot;</span><span class="p">,</span> <span class="s2">&quot;project&quot;</span><span class="p">),</span>
            <span class="nb">tuple</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)),</span>
        <span class="p">)</span>
    <span class="p">)</span>


<span class="nd">@dffml</span><span class="o">.</span><span class="n">op</span><span class="p">(</span>
    <span class="n">inputs</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;org&quot;</span><span class="p">:</span> <span class="n">github_split_owner_project</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;owner&quot;</span><span class="p">],</span>
        <span class="s2">&quot;project&quot;</span><span class="p">:</span> <span class="n">github_split_owner_project</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">],</span>
    <span class="p">},</span>
    <span class="n">outputs</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;repo&quot;</span><span class="p">:</span> <span class="n">dffml</span><span class="o">.</span><span class="n">Definition</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;PyGithub.Repository&quot;</span><span class="p">,</span> <span class="n">primitive</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">},</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">github_get_repo</span><span class="p">(</span><span class="n">org</span><span class="p">,</span> <span class="n">project</span><span class="p">):</span>
    <span class="c1"># Instantiate a GitHub API object</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">github</span><span class="o">.</span><span class="n">Github</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;GITHUB_TOKEN&quot;</span><span class="p">])</span>
    <span class="c1"># Make the request for the repo</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;repo&quot;</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">org</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">project</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)}</span>


<span class="nd">@dffml</span><span class="o">.</span><span class="n">op</span><span class="p">(</span>
    <span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;repo&quot;</span><span class="p">:</span> <span class="n">github_get_repo</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;repo&quot;</span><span class="p">],},</span>
    <span class="n">outputs</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;raw_repo&quot;</span><span class="p">:</span> <span class="n">dffml</span><span class="o">.</span><span class="n">Definition</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;PyGithub.Repository.Raw&quot;</span><span class="p">,</span> <span class="n">primitive</span><span class="o">=</span><span class="s2">&quot;object&quot;</span>
        <span class="p">),</span>
    <span class="p">},</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">github_repo_raw</span><span class="p">(</span><span class="n">repo</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;raw_repo&quot;</span><span class="p">:</span> <span class="n">repo</span><span class="o">.</span><span class="n">_rawData</span><span class="p">}</span>


<span class="c1"># If this script is run via `python gh.py intel dffml`, it will print out the</span>
<span class="c1"># repo data using the pprint module.</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="kn">import</span> <span class="nn">pprint</span>

    <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span>
        <span class="n">github_repo_raw</span><span class="p">(</span><span class="n">github_get_repo</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="s2">&quot;repo&quot;</span><span class="p">])</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>You’ll notice that we wrote a function, and then put an <code class="docutils literal notranslate"><span class="pre">if</span></code> statement. The
<code class="docutils literal notranslate"><span class="pre">if</span></code> block let’s us only run the code within the block when the script is run
directly (rather than when included via <code class="docutils literal notranslate"><span class="pre">import</span></code>).</p>
<p>If we run Python on the script, and pass an org name followed by a repo name,
our <code class="docutils literal notranslate"><span class="pre">if</span></code> block will run the function and print the raw data of the repsonse
received from GitHub, containing a bunch of information about the repo.</p>
<p>You’ll notice that the data being output here is a superset of the data we’d see
for the repo in the <code class="docutils literal notranslate"><span class="pre">repos.json</span></code> file. Meaning we have all the required data
and more.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>python operations/gh.py intel dffml
<span class="go">{&#39;allow_auto_merge&#39;: False,</span>
<span class="go"> &lt;... output clipped ...&gt;</span>
<span class="go"> &#39;full_name&#39;: &#39;intel/dffml&#39;,</span>
<span class="go"> &lt;... output clipped ...&gt;</span>
<span class="go"> &#39;html_url&#39;: &#39;https://github.com/intel/dffml&#39;,</span>
<span class="go"> &lt;... output clipped ...&gt;</span>
<span class="go"> &#39;watchers_count&#39;: 135}</span>
</pre></div>
</div>
</section>
<section id="dataflow">
<h2>DataFlow<a class="headerlink" href="#dataflow" title="Permalink to this heading">¶</a></h2>
<p>Let’s create a backup of the <code class="docutils literal notranslate"><span class="pre">repos.json</span></code> file, since we’ll be overwriting it
with our own.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cp html-client/repos.json repos.json.bak
</pre></div>
</div>
<p>We’re going to create a Python script which will use all the operations we’ve
written, and the sources.</p>
<p><strong>dataflow.py</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">pathlib</span>

<span class="kn">import</span> <span class="nn">dffml</span>

<span class="c1"># Import the sources we implemented</span>
<span class="kn">from</span> <span class="nn">sources.orgs_repos_yml</span> <span class="kn">import</span> <span class="n">OrgsReposYAMLSource</span>
<span class="kn">from</span> <span class="nn">sources.sap_portal_repos_json</span> <span class="kn">import</span> <span class="n">SAPPortalReposJSONSource</span>

<span class="c1"># Import all the operations we implemented into this file&#39;s global namespace</span>
<span class="kn">from</span> <span class="nn">operations.gh</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># Read in the repos.json backup to learn it&#39;s format. It&#39;s in the same directory</span>
<span class="c1"># as this file (dataflow.py) so we can reference it by looking in the parent</span>
<span class="c1"># directory of this file and then down (via .joinpath()) into repos.json.bak</span>
<span class="n">repos_json_bak_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;repos.json.bak&quot;</span><span class="p">)</span>
<span class="c1"># Read in the contents</span>
<span class="n">repos_json_bak_text</span> <span class="o">=</span> <span class="n">repos_json_bak_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
<span class="c1"># Parse the contents</span>
<span class="n">repos_json_bak</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">repos_json_bak_text</span><span class="p">)</span>
<span class="c1"># We&#39;ll inspect the first element in the list to find out what keys must be</span>
<span class="c1"># present in the object</span>
<span class="n">required_data_top_level</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">repos_json_bak</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="c1"># It should look like this:</span>
<span class="c1">#   required_data_top_level = [</span>
<span class="c1">#       &#39;id&#39;, &#39;name&#39;, &#39;full_name&#39;, &#39;html_url&#39;, &#39;description&#39;, &#39;created_at&#39;,</span>
<span class="c1">#       &#39;updated_at&#39;, &#39;pushed_at&#39;, &#39;stargazers_count&#39;, &#39;watchers_count&#39;,</span>
<span class="c1">#       &#39;language&#39;, &#39;forks_count&#39;, &#39;open_issues_count&#39;, &#39;license&#39;,</span>
<span class="c1">#       &#39;default_branch&#39;, &#39;owner&#39;, &#39;_InnerSourceMetadata&#39;</span>
<span class="c1">#   ]</span>
<span class="c1"># We&#39;re first going to create output operations to grab each of the keys</span>
<span class="c1"># We know that _InnerSourceMetadata is not a single value, so we&#39;ll handle that</span>
<span class="c1"># separately and remove it from our list</span>
<span class="n">required_data_top_level</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;_InnerSourceMetadata&quot;</span><span class="p">)</span>

<span class="c1"># Make a list of any imported OpeartionImplementations (functions decorated with</span>
<span class="c1"># @op()) from any that are in the global namespace of this file</span>
<span class="n">operation_implementations</span> <span class="o">=</span> <span class="n">dffml</span><span class="o">.</span><span class="n">opimp_in</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="vm">__name__</span><span class="p">])</span>

<span class="c1"># Create a DataFlow using every operation in all the modules we imported. Also</span>
<span class="c1"># use the remap operation</span>
<span class="n">dataflow</span> <span class="o">=</span> <span class="n">dffml</span><span class="o">.</span><span class="n">DataFlow</span><span class="p">(</span>
    <span class="n">dffml</span><span class="o">.</span><span class="n">remap</span><span class="p">,</span>
    <span class="o">*</span><span class="n">operation_implementations</span><span class="p">,</span>
    <span class="c1"># The remap operation allows us to specify which keys should appear in the</span>
    <span class="c1"># outputs of each dataflow run. We do that by configuring it to use a</span>
    <span class="c1"># subflow, which is a dataflow run within a dataflow.</span>
    <span class="c1"># TODO(pdxjohnny) Remove .export() after unifying config code.</span>
    <span class="n">configs</span><span class="o">=</span><span class="p">{</span>
        <span class="n">dffml</span><span class="o">.</span><span class="n">remap</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="p">{</span>
            <span class="c1"># Our subflow will run the get_single operation, which grabs one</span>
            <span class="c1"># Input object matching the given definition name. The one Input we</span>
            <span class="c1"># grab at first is the raw ouput of the PyGithub Repository object.</span>
            <span class="s2">&quot;dataflow&quot;</span><span class="p">:</span> <span class="n">dffml</span><span class="o">.</span><span class="n">DataFlow</span><span class="p">(</span>
                <span class="n">dffml</span><span class="o">.</span><span class="n">GetSingle</span><span class="p">,</span>
                <span class="n">seed</span><span class="o">=</span><span class="p">[</span>
                    <span class="n">dffml</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span>
                        <span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="n">github_repo_raw</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;raw_repo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
                        <span class="n">definition</span><span class="o">=</span><span class="n">dffml</span><span class="o">.</span><span class="n">GetSingle</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">],</span>
                    <span class="p">)</span>
                <span class="p">],</span>
            <span class="p">)</span><span class="o">.</span><span class="n">export</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="n">seed</span><span class="o">=</span><span class="p">[</span>
        <span class="n">dffml</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span>
            <span class="c1"># The output of the top level dataflow will be a dict where the keys</span>
            <span class="c1"># are what we give here, and the values are the output of a call to</span>
            <span class="c1"># traverse_get(), where the keys to traverse are the values we give</span>
            <span class="c1"># here, and the dict being traversed the results from the subflow.</span>
            <span class="c1"># {key: traverse_get(subflow_results, *value)}</span>
            <span class="n">value</span><span class="o">=</span><span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="p">[</span><span class="n">github_repo_raw</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;raw_repo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">required_data_top_level</span>
            <span class="p">},</span>
            <span class="n">definition</span><span class="o">=</span><span class="n">dffml</span><span class="o">.</span><span class="n">remap</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">],</span>
        <span class="p">)</span>
    <span class="p">],</span>
<span class="p">)</span>


<span class="c1"># Path to the output repos.json file</span>
<span class="n">repos_json_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
    <span class="s2">&quot;html-client&quot;</span><span class="p">,</span> <span class="s2">&quot;repos.json&quot;</span>
<span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># Clear the file so we overwrite with new data</span>
    <span class="n">repos_json_path</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="s2">&quot;[]&quot;</span><span class="p">)</span>
    <span class="c1"># Create and enter our sources (__aenter__()) following the Double Context</span>
    <span class="c1"># Entry pattern (see tutorial page for more details)</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">OrgsReposYAMLSource</span><span class="p">(</span>
        <span class="n">directory</span><span class="o">=</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;orgs&quot;</span><span class="p">)</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">input_source</span><span class="p">,</span> <span class="n">SAPPortalReposJSONSource</span><span class="p">(</span>
        <span class="n">filename</span><span class="o">=</span><span class="n">repos_json_path</span><span class="p">,</span> <span class="n">readwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">output_source</span><span class="p">:</span>
        <span class="c1"># Second context entry</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">input_source</span><span class="p">()</span> <span class="k">as</span> <span class="n">input_source_ctx</span><span class="p">,</span> <span class="n">output_source</span><span class="p">()</span> <span class="k">as</span> <span class="n">output_source_ctx</span><span class="p">:</span>
            <span class="c1"># Run the dataflow</span>
            <span class="k">async</span> <span class="k">for</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">results</span> <span class="ow">in</span> <span class="n">dffml</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="n">dataflow</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="c1"># We will run the dataflow on all input repos at the same</span>
                    <span class="c1"># time. The dataflow will run on each repo / record</span>
                    <span class="c1"># concurrently. We do this by creating a dictionary where</span>
                    <span class="c1"># each key is an InputSetContext, a RecordInputSetContext to</span>
                    <span class="c1"># be excat, since the context for each run is tied to the</span>
                    <span class="c1"># record / repo.</span>
                    <span class="n">dffml</span><span class="o">.</span><span class="n">RecordInputSetContext</span><span class="p">(</span><span class="n">record</span><span class="p">):</span> <span class="p">[</span>
                        <span class="c1"># Create a list of Inputs for each record&#39;s context. The</span>
                        <span class="c1"># only input we add at this time is the url of the repo.</span>
                        <span class="n">dffml</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span>
                            <span class="n">value</span><span class="o">=</span><span class="n">record</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
                            <span class="n">definition</span><span class="o">=</span><span class="n">dataflow</span><span class="o">.</span><span class="n">definitions</span><span class="p">[</span><span class="s2">&quot;github.repo.url&quot;</span><span class="p">],</span>
                        <span class="p">)</span>
                    <span class="p">]</span>
                    <span class="k">async</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">input_source_ctx</span><span class="o">.</span><span class="n">records</span><span class="p">()</span>
                <span class="p">},</span>
                <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="c1"># Update the feature data of the record. The feature data is</span>
                <span class="c1"># what we are writing out to repos.json in the source we</span>
                <span class="c1"># implemented.</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">record</span><span class="o">.</span><span class="n">evaluated</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
                <span class="c1"># Print results for debugging purposes</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">record</span><span class="o">.</span><span class="n">export</span><span class="p">())</span>
                <span class="c1"># Save to output repos.json</span>
                <span class="k">await</span> <span class="n">output_source_ctx</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">record</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</pre></div>
</div>
<p>We can run the file the run the dataflow on all the input repos and save the
results to <code class="docutils literal notranslate"><span class="pre">repos.json</span></code>.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>python dataflow.py
</pre></div>
</div>
<p>If you go to <a class="reference external" href="http://127.0.0.1:8080">http://127.0.0.1:8080</a></p>
<img alt="Screenshot of SAP InnerSource portal showing new projects" src="https://user-images.githubusercontent.com/5950433/128045522-54b3193c-826b-48aa-b82e-96306831d595.png" />
<p>We can also export the dataflow for use with the CLI, HTTP service, etc.</p>
<p><strong>TODO</strong> Add link to webui when complete. It will be used for editing dataflows.
ETA Oct 2021.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>dffml service dev <span class="nb">export</span> dataflow:dataflow <span class="p">|</span> tee dataflow.json
</pre></div>
</div>
<p>We can run the dataflow using the DFFML command line interface rather than
running the Python file.</p>
<p>The following command replicates loading from the <code class="docutils literal notranslate"><span class="pre">orgs/</span></code> source and updating
the <code class="docutils literal notranslate"><span class="pre">repos.json</span></code> source. Just as we did in Python, we add the record key to
each dataflow run as an input with the definition being <code class="docutils literal notranslate"><span class="pre">github.repo.url</span></code>.
You can add <code class="docutils literal notranslate"><span class="pre">-log</span> <span class="pre">debug</span></code> to see verbose output.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>dffml dataflow run records all <span class="se">\</span>
    -dataflow dataflow.json <span class="se">\</span>
    -record-def <span class="s2">&quot;github.repo.url&quot;</span> <span class="se">\</span>
    -sources <span class="se">\</span>
      <span class="nv">orgs</span><span class="o">=</span>sources.orgs_repos_yml:OrgsReposYAMLSource <span class="se">\</span>
      <span class="nv">portal</span><span class="o">=</span>sources.sap_portal_repos_json:SAPPortalReposJSONSource <span class="se">\</span>
    -source-orgs-directory orgs/ <span class="se">\</span>
    -source-portal-filename html-client/repos.json <span class="se">\</span>
    -source-portal-readwrite <span class="se">\</span>
    -update
</pre></div>
</div>
<p>If you want to run the dataflow on a single repo and add the data to the
repos.json file, you can do it as follows.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>dffml dataflow run records <span class="nb">set</span> <span class="se">\</span>
    -dataflow dataflow.json <span class="se">\</span>
    -record-def <span class="s2">&quot;github.repo.url&quot;</span> <span class="se">\</span>
    -sources <span class="se">\</span>
      <span class="nv">portal</span><span class="o">=</span>sources.sap_portal_repos_json:SAPPortalReposJSONSource <span class="se">\</span>
    -source-portal-filename html-client/repos.json <span class="se">\</span>
    -source-portal-readwrite <span class="se">\</span>
    -update <span class="se">\</span>
    -keys <span class="se">\</span>
      https://github.com/intel/dffml
</pre></div>
</div>
<p>If you want to run the dataflow on a single repo, without updating the source,
you can do it as follows, by omiting the source related arguments.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>dffml dataflow run records <span class="nb">set</span> <span class="se">\</span>
    -dataflow dataflow.json <span class="se">\</span>
    -record-def <span class="s2">&quot;github.repo.url&quot;</span> <span class="se">\</span>
    -keys <span class="se">\</span>
      https://github.com/intel/dffml
</pre></div>
</div>
</section>
</section>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="microservice.html" class="btn btn-neutral float-right" title="InnerSource Microservice" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="index.html" class="btn btn-neutral float-left" title="InnerSource" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2017 - 2022, Intel.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>