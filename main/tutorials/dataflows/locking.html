<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Using Locks In DataFlow &mdash; DFFML 5b53a7dbe documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/tabs.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Prediction Using IO Operations" href="io.html" />
    <link rel="prev" title="DataFlows" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> DFFML
          </a>
              <div class="version">
                5b53a7dbe
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../concepts/index.html">Concepts</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Usage</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../quickstart/model.html">Quickstart</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../models/index.html">Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sources/index.html">Sources</a></li>
<li class="toctree-l2"><a class="reference internal" href="../accuracy/index.html">Scorers</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">DataFlows</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Using Locks In DataFlow</a></li>
<li class="toctree-l3"><a class="reference internal" href="io.html">Prediction Using IO Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="chatbot.html">Gitter ML Inference Chatbot</a></li>
<li class="toctree-l3"><a class="reference internal" href="nlp.html">Using NLP Operations</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../neuralnetwork.html">Neural Networks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../doublecontextentry.html">Double Context Entry</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../examples/index.html">Examples</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../plugins/index.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli.html">Command Line</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plugins/service/http/index.html">HTTP API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/base.html">Base</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/log.html">Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/noasync.html">Noasync</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/plugins.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/record.html">Record</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/version.html">Version</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/db/index.html">Db</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/cli/index.html">Cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/df/index.html">Df</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/high_level/index.html">High_Level</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/tuner/index.html">Tuner</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/service/index.html">Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/util/index.html">Util</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/configloader/index.html">Configloader</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/accuracy/index.html">Accuracy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/source/index.html">Source</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/operation/index.html">Operation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/model/index.html">Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/secret/index.html">Secret</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/port/index.html">Port</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/feature/index.html">Feature</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../arch/index.html">Architecture</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Subprojects</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../shouldi.html">shouldi</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Community</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/intel/dffml">GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://intel.github.io/dffml/main/">Master Branch Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../publications.html">Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contact.html">Contact Us</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/index.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../news/index.html">News</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">DFFML</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Tutorials</a> &raquo;</li>
          <li><a href="index.html">DataFlows</a> &raquo;</li>
      <li>Using Locks In DataFlow</li>


      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/intel/dffml/blob/main/docs/tutorials/dataflows/locking.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>


  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="using-locks-in-dataflow">
<h1>Using Locks In DataFlow<a class="headerlink" href="#using-locks-in-dataflow" title="Permalink to this headline">ÔÉÅ</a></h1>
<p>All the operations in DFFML runs asynchronously. DFFML takes care of locking objects which
might be used by multiple operations so that you don‚Äôt run in to any race conditions.
This example shows one such usage.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>All the code for this example is located under the
<a class="reference external" href="https://github.com/intel/dffml/blob/main/examples/dataflow/locking">examples/dataflow/locking</a>
directory of the DFFML source code.</p>
</div>
<p>First we import required packages and objects, and create Definitions for each
data type our operation will use. Note that <code class="docutils literal notranslate"><span class="pre">LOCKED_OBJ</span></code> has <code class="docutils literal notranslate"><span class="pre">lock=True</span></code>.</p>
<p><strong>example.py</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">dffml</span> <span class="kn">import</span> <span class="n">Definition</span><span class="p">,</span> <span class="n">DataFlow</span><span class="p">,</span> <span class="n">Input</span><span class="p">,</span> <span class="n">op</span>
<span class="kn">from</span> <span class="nn">dffml.noasync</span> <span class="kn">import</span> <span class="n">run</span>

<span class="n">OBJ</span> <span class="o">=</span> <span class="n">Definition</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;obj&quot;</span><span class="p">,</span> <span class="n">primitive</span><span class="o">=</span><span class="s2">&quot;mapping&quot;</span><span class="p">)</span>
<span class="n">LOCKED_OBJ</span> <span class="o">=</span> <span class="n">Definition</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;locked_obj&quot;</span><span class="p">,</span> <span class="n">primitive</span><span class="o">=</span><span class="s2">&quot;mapping&quot;</span><span class="p">,</span> <span class="n">lock</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">SLEEP_TIME</span> <span class="o">=</span> <span class="n">Definition</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;sleep_time&quot;</span><span class="p">,</span> <span class="n">primitive</span><span class="o">=</span><span class="s2">&quot;int&quot;</span><span class="p">)</span>
<span class="n">INTEGER</span> <span class="o">=</span> <span class="n">Definition</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;integer&quot;</span><span class="p">,</span> <span class="n">primitive</span><span class="o">=</span><span class="s2">&quot;int&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Our operation <code class="docutils literal notranslate"><span class="pre">run_me</span></code> takes an object(of definition OBJ) sets the <code class="docutils literal notranslate"><span class="pre">i</span></code>
attribute of it, sleeps for given time finally prints the value which was given
as input and the current value of the object.</p>
<p><strong>example.py</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@op</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;obj&quot;</span><span class="p">:</span> <span class="n">OBJ</span><span class="p">,</span> <span class="s2">&quot;sleep_for&quot;</span><span class="p">:</span> <span class="n">SLEEP_TIME</span><span class="p">,</span> <span class="s2">&quot;i&quot;</span><span class="p">:</span> <span class="n">INTEGER</span><span class="p">})</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">run_me</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">sleep_for</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;i&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_for</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set i = </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, got i = </span><span class="si">{</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>We‚Äôll run the dataflow with two values for i. If the operations run as expected when printing,
the value given as input and that of the object would be same.</p>
<p><strong>example.py</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running dataflow without locked object&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">run</span><span class="p">(</span>
    <span class="n">DataFlow</span><span class="p">(</span><span class="n">run_me</span><span class="p">),</span>
    <span class="p">[</span>
        <span class="n">Input</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">{},</span> <span class="n">definition</span><span class="o">=</span><span class="n">OBJ</span><span class="p">),</span>
        <span class="n">Input</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">definition</span><span class="o">=</span><span class="n">SLEEP_TIME</span><span class="p">),</span>
        <span class="n">Input</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">definition</span><span class="o">=</span><span class="n">SLEEP_TIME</span><span class="p">),</span>
        <span class="n">Input</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">definition</span><span class="o">=</span><span class="n">INTEGER</span><span class="p">),</span>
        <span class="n">Input</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">definition</span><span class="o">=</span><span class="n">INTEGER</span><span class="p">),</span>
    <span class="p">],</span>
<span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>But this codeblock gives an output</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Running</span> <span class="n">dataflow</span> <span class="n">without</span> <span class="n">locked</span> <span class="nb">object</span>
<span class="nb">set</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">got</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
<span class="nb">set</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">got</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
<span class="nb">set</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">got</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
<span class="nb">set</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">got</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
<p>We can see that the output is not what we expect. Since everything is running asynchronously,
when one operations sleeps the other operation might start running and it replaces the
value. This is where locks come handy. We‚Äôll set <code class="docutils literal notranslate"><span class="pre">run_me</span></code> to take object of definition
<code class="docutils literal notranslate"><span class="pre">LOCKED_OBJ</span></code> instead of <code class="docutils literal notranslate"><span class="pre">OBJ</span></code> and run the dataflow again.</p>
<p><strong>example.py</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running dataflow with locked object&quot;</span><span class="p">)</span>
<span class="n">run_me</span><span class="o">.</span><span class="n">op</span> <span class="o">=</span> <span class="n">run_me</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
    <span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;obj&quot;</span><span class="p">:</span> <span class="n">LOCKED_OBJ</span><span class="p">,</span> <span class="s2">&quot;sleep_for&quot;</span><span class="p">:</span> <span class="n">SLEEP_TIME</span><span class="p">,</span> <span class="s2">&quot;i&quot;</span><span class="p">:</span> <span class="n">INTEGER</span><span class="p">}</span>
<span class="p">)</span>
<span class="k">for</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">run</span><span class="p">(</span>
    <span class="n">DataFlow</span><span class="p">(</span><span class="n">run_me</span><span class="p">),</span>
    <span class="p">[</span>
        <span class="n">Input</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">{},</span> <span class="n">definition</span><span class="o">=</span><span class="n">LOCKED_OBJ</span><span class="p">),</span>
        <span class="n">Input</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">definition</span><span class="o">=</span><span class="n">SLEEP_TIME</span><span class="p">),</span>
        <span class="n">Input</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">definition</span><span class="o">=</span><span class="n">SLEEP_TIME</span><span class="p">),</span>
        <span class="n">Input</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">definition</span><span class="o">=</span><span class="n">INTEGER</span><span class="p">),</span>
        <span class="n">Input</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">definition</span><span class="o">=</span><span class="n">INTEGER</span><span class="p">),</span>
    <span class="p">],</span>
<span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>This time the output is as expected</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Running</span> <span class="n">dataflow</span> <span class="k">with</span> <span class="n">locked</span> <span class="nb">object</span>
<span class="nb">set</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">got</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span>
<span class="nb">set</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">got</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
<span class="nb">set</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">got</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span>
<span class="nb">set</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">got</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="DataFlows" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="io.html" class="btn btn-neutral float-right" title="Prediction Using IO Operations" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017 - 2022, Intel.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>